<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - Easy Mode</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        .game-container {
            position: relative;
            background: #70c5ce;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        .score {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        .coin-display {
            position: absolute;
            top: 30px;
            right: 20px;
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        .coin-icon {
            width: 30px;
            height: 30px;
            margin-right: 8px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: #333;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .time-indicator {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .time-indicator.show {
            opacity: 1;
        }
        .start-screen, .game-over-screen, .character-selection {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            pointer-events: all;
            transition: opacity 0.3s ease;
        }
        .start-screen h1, .game-over-screen h1, .character-selection h1 {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
        }
        .start-screen p, .game-over-screen p, .character-selection p {
            font-size: 20px;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        .btn {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 15px 40px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn:disabled {
            background: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        .best-score {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        .instructions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 16px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }
        .character-container {
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            position: relative;
            margin-bottom: 30px;
        }
        .character-options {
            display: flex;
            gap: 30px;
            transition: transform 0.3s ease;
            padding: 0 20px;
        }
        .character-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            width: 150px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            flex-shrink: 0;
            position: relative;
        }
        .character-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }
        .character-card.selected {
            border-color: #FFD700;
            background: rgba(255, 215, 0, 0.2);
        }
        .character-card.locked {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .character-card.locked:hover {
            transform: none;
            background: rgba(255, 255, 255, 0.1);
        }
        .lock-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: #FF5252;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: white;
        }
        .character-preview {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            position: relative;
        }
        .character-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .character-desc {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        .character-price {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
        }
        .price-coin {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: #333;
        }
        .scroll-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .scroll-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transition: background 0.3s ease;
        }
        .scroll-dot.active {
            background: #FFD700;
        }
        .swipe-hint {
            font-size: 14px;
            opacity: 0.7;
            margin-top: 10px;
        }
        .coin-collected {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            animation: coinFloat 1s ease-out forwards;
        }
        @keyframes coinFloat {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="400" height="600"></canvas>
        
        <div class="game-ui">
            <div class="score" id="score">0</div>
            <div class="coin-display">
                <div class="coin-icon">$</div>
                <span id="coinCount">0</span>
            </div>
            <div class="time-indicator" id="timeIndicator">Day Time</div>
            <div class="best-score" id="bestScore">Best: 0</div>
            
            <div class="start-screen" id="startScreen">
                <h1>Flappy Bird</h1>
                <p>Easy Mode - Collect coins to unlock characters!</p>
                <button class="btn" onclick="showCharacterSelection()">Select Character</button>
                <div class="instructions">Press SPACE or Click to Flap</div>
            </div>
            
            <div class="character-selection hidden" id="characterSelection">
                <h1>Select Your Bird</h1>
                <p>Choose your character to play with</p>
                
                <div class="character-container" id="characterContainer">
                    <div class="character-options" id="characterOptions">
                        <div class="character-card" onclick="selectCharacter('bird')" id="birdCard">
                            <div class="character-preview">
                                <canvas id="birdPreview" width="80" height="80"></canvas>
                            </div>
                            <div class="character-name">Bird</div>
                            <div class="character-desc">Balanced</div>
                            <div class="character-price">FREE</div>
                        </div>
                        
                        <div class="character-card locked" onclick="purchaseCharacter('eagle')" id="eagleCard">
                            <div class="lock-icon">🔒</div>
                            <div class="character-preview">
                                <canvas id="eaglePreview" width="80" height="80"></canvas>
                            </div>
                            <div class="character-name">Eagle</div>
                            <div class="character-desc">Stronger</div>
                            <div class="character-price">
                                <div class="price-coin">$</div>
                                <span>50</span>
                            </div>
                        </div>
                        
                        <div class="character-card locked" onclick="purchaseCharacter('crow')" id="crowCard">
                            <div class="lock-icon">🔒</div>
                            <div class="character-preview">
                                <canvas id="crowPreview" width="80" height="80"></canvas>
                            </div>
                            <div class="character-name">Crow</div>
                            <div class="character-desc">Faster</div>
                            <div class="character-price">
                                <div class="price-coin">$</div>
                                <span>100</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="scroll-indicator">
                        <div class="scroll-dot active" id="dot1"></div>
                        <div class="scroll-dot" id="dot2"></div>
                        <div class="scroll-dot" id="dot3"></div>
                    </div>
                </div>
                
                <div class="swipe-hint">Swipe left or right to see more characters</div>
                
                <button class="btn" onclick="startGame()">Start Game</button>
            </div>
            
            <div class="game-over-screen hidden" id="gameOverScreen">
                <h1>Game Over</h1>
                <p id="finalScore">Score: 0</p>
                <p id="coinsEarned">Coins Earned: 0</p>
                <button class="btn" onclick="restartGame()">Play Again</button>
            </div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');
        const coinCountElement = document.getElementById('coinCount');
        const bestScoreElement = document.getElementById('bestScore');
        const timeIndicator = document.getElementById('timeIndicator');
        const startScreen = document.getElementById('startScreen');
        const characterSelection = document.getElementById('characterSelection');
        const characterOptions = document.getElementById('characterOptions');
        const characterContainer = document.getElementById('characterContainer');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreElement = document.getElementById('finalScore');
        const coinsEarnedElement = document.getElementById('coinsEarned');
        
        // Game variables
        let gameState = 'start'; // 'start', 'characterSelection', 'playing', 'gameOver'
        let score = 0;
        let bestScore = localStorage.getItem('flappyBestScore') || 0;
        let coins = parseInt(localStorage.getItem('flappyCoins')) || 0;
        let coinsEarnedThisRound = 0;
        let selectedCharacter = 'bird';
        let currentCharacterIndex = 0;
        let timePhase = 'day'; // 'day', 'evening', 'night'
        let lastPhaseChangeScore = 0;
        let timeIndicatorTimeout = null;
        let activeAnimations = [];
        
        // Unlocked characters
        let unlockedCharacters = JSON.parse(localStorage.getItem('unlockedCharacters')) || ['bird'];
        
        // Update UI
        bestScoreElement.textContent = `Best: ${bestScore}`;
        coinCountElement.textContent = coins;
        
        // Time phase configurations
        const timePhases = {
            day: {
                skyGradient: ['#87CEEB', '#98D8E8'],
                pipeColor: '#228B22',
                pipeStrokeColor: '#006400',
                groundColor: '#8B4513',
                grassColor: '#228B22',
                cloudColor: 'rgba(255, 255, 255, 0.8)',
                indicatorText: 'Day Time',
                indicatorColor: 'white'
            },
            evening: {
                skyGradient: ['#FF7E5F', '#FEB47B'],
                pipeColor: '#CD853F',
                pipeStrokeColor: '#8B4513',
                groundColor: '#5D4037',
                grassColor: '#8D6E63',
                cloudColor: 'rgba(255, 255, 255, 0.6)',
                indicatorText: 'Evening Time',
                indicatorColor: '#FFD700'
            },
            night: {
                skyGradient: ['#0c1445', '#1a237e'],
                pipeColor: '#37474F',
                pipeStrokeColor: '#263238',
                groundColor: '#212121',
                grassColor: '#424242',
                cloudColor: 'rgba(200, 200, 255, 0.5)',
                indicatorText: 'Night Time',
                indicatorColor: '#BBDEFB'
            }
        };
        
        // Character definitions with prices
        const characters = {
            bird: {
                width: 34,
                height: 24,
                gravity: 0.2,
                jumpPower: -4.5,
                color: '#FFD700',
                wingColor: '#FFA500',
                beakColor: '#FF6347',
                price: 0,
                unlocked: true
            },
            eagle: {
                width: 40,
                height: 30,
                gravity: 0.18,
                jumpPower: -5.0,
                color: '#8B4513',
                wingColor: '#A0522D',
                beakColor: '#FFD700',
                price: 50,
                unlocked: false
            },
            crow: {
                width: 36,
                height: 26,
                gravity: 0.22,
                jumpPower: -4.8,
                color: '#333333',
                wingColor: '#555555',
                beakColor: '#000000',
                price: 100,
                unlocked: false
            }
        };
        
        // Update unlocked characters from localStorage
        unlockedCharacters.forEach(char => {
            if (characters[char]) {
                characters[char].unlocked = true;
            }
        });
        
        // Bird properties
        const bird = {
            x: 80,
            y: canvas.height / 2,
            velocity: 0,
            rotation: 0
        };
        
        // Pipe properties
        const pipes = [];
        const pipeWidth = 60;
        const pipeGap = 180; // Larger gap for easier gameplay
        const pipeSpeed = 2;
        let pipeTimer = 0;
        const pipeInterval = 120; // Frames between pipes
        
        // Coin properties
        const coinsInGame = [];
        const coinRadius = 15;
        let coinTimer = 0;
        const coinInterval = 180; // Frames between coins
        
        // Background elements
        const clouds = [];
        for (let i = 0; i < 3; i++) {
            clouds.push({
                x: Math.random() * canvas.width,
                y: Math.random() * 150, // Reduced max height to keep clouds visible
                width: 60 + Math.random() * 40,
                speed: 0.5 + Math.random() * 0.5
            });
        }
        
        // Touch/swipe variables
        let touchStartX = 0;
        let touchEndX = 0;
        let isDragging = false;
        let startX = 0;
        let scrollLeft = 0;
        
        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (gameState === 'playing') {
                    flap();
                }
            }
        });
        
        canvas.addEventListener('click', () => {
            if (gameState === 'playing') {
                flap();
            }
        });
        
        // Touch events for character selection
        characterContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        characterContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
        
        // Mouse events for character selection
        characterContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.pageX - characterContainer.offsetLeft;
            scrollLeft = characterContainer.scrollLeft;
        });
        
        characterContainer.addEventListener('mouseleave', () => {
            isDragging = false;
        });
        
        characterContainer.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            handleSwipe();
        });
        
        characterContainer.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - characterContainer.offsetLeft;
            const walk = (x - startX) * 2; // Scroll speed
            characterContainer.scrollLeft = scrollLeft - walk;
        });
        
        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                // Swipe left
                navigateCharacter(1);
            } else if (touchEndX > touchStartX + 50) {
                // Swipe right
                navigateCharacter(-1);
            }
        }
        
        function navigateCharacter(direction) {
            const characterCards = document.querySelectorAll('.character-card');
            const containerWidth = characterContainer.clientWidth;
            const cardWidth = characterCards[0].offsetWidth + 30; // Include gap
            
            currentCharacterIndex += direction;
            
            // Boundary check
            if (currentCharacterIndex < 0) {
                currentCharacterIndex = 0;
            } else if (currentCharacterIndex >= characterCards.length) {
                currentCharacterIndex = characterCards.length - 1;
            }
            
            // Calculate scroll position
            const scrollPosition = currentCharacterIndex * cardWidth - (containerWidth - cardWidth) / 2;
            characterContainer.scrollTo({
                left: scrollPosition,
                behavior: 'smooth'
            });
            
            // Update scroll indicators
            updateScrollIndicators();
            
            // Auto-select the centered character if unlocked
            const characterTypes = ['bird', 'eagle', 'crow'];
            if (characters[characterTypes[currentCharacterIndex]].unlocked) {
                selectCharacter(characterTypes[currentCharacterIndex], false); // Don't scroll again
            }
        }
        
        function updateScrollIndicators() {
            const dots = document.querySelectorAll('.scroll-dot');
            dots.forEach((dot, index) => {
                if (index === currentCharacterIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }
        
        function updateTimePhase() {
            const scoreThreshold = 50;
            const oldPhase = timePhase;
            
            if (score < scoreThreshold) {
                timePhase = 'day';
            } else if (score < scoreThreshold * 2) {
                timePhase = 'evening';
            } else {
                timePhase = 'night';
            }
            
            // If phase changed, show indicator
            if (oldPhase !== timePhase) {
                showTimeIndicator();
            }
        }
        
        function showTimeIndicator() {
            const phase = timePhases[timePhase];
            timeIndicator.textContent = phase.indicatorText;
            timeIndicator.style.color = phase.indicatorColor;
            timeIndicator.classList.add('show');
            
            // Clear any existing timeout
            if (timeIndicatorTimeout) {
                clearTimeout(timeIndicatorTimeout);
            }
            
            // Hide after 2 seconds
            timeIndicatorTimeout = setTimeout(() => {
                timeIndicator.classList.remove('show');
            }, 2000);
        }
        
        function flap() {
            bird.velocity = characters[selectedCharacter].jumpPower;
        }
        
        function showCharacterSelection() {
            gameState = 'characterSelection';
            startScreen.classList.add('hidden');
            characterSelection.classList.remove('hidden');
            
            // Update character cards based on unlocked status
            updateCharacterCards();
            
            // Draw character previews
            drawCharacterPreview('bird', document.getElementById('birdPreview'));
            drawCharacterPreview('eagle', document.getElementById('eaglePreview'));
            drawCharacterPreview('crow', document.getElementById('crowPreview'));
            
            // Select bird by default
            selectCharacter('bird');
            currentCharacterIndex = 0;
            updateScrollIndicators();
        }
        
        function updateCharacterCards() {
            Object.keys(characters).forEach(charType => {
                const card = document.getElementById(charType + 'Card');
                const char = characters[charType];
                
                if (char.unlocked) {
                    card.classList.remove('locked');
                    card.onclick = () => selectCharacter(charType);
                    const lockIcon = card.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.style.display = 'none';
                } else {
                    card.classList.add('locked');
                    card.onclick = () => purchaseCharacter(charType);
                    const lockIcon = card.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.style.display = 'flex';
                }
            });
        }
        
        function purchaseCharacter(characterType) {
            const char = characters[characterType];
            
            if (char.unlocked) {
                selectCharacter(characterType);
                return;
            }
            
            if (coins >= char.price) {
                // Purchase character
                coins -= char.price;
                char.unlocked = true;
                if (!unlockedCharacters.includes(characterType)) {
                    unlockedCharacters.push(characterType);
                }
                
                // Save to localStorage
                localStorage.setItem('flappyCoins', coins);
                localStorage.setItem('unlockedCharacters', JSON.stringify(unlockedCharacters));
                
                // Update UI
                coinCountElement.textContent = coins;
                updateCharacterCards();
                
                // Select the purchased character
                selectCharacter(characterType);
                
                // Show purchase success animation
                showPurchaseSuccess(characterType);
            } else {
                // Not enough coins
                showNotEnoughCoins();
            }
        }
        
        function showPurchaseSuccess(characterType) {
            const card = document.getElementById(characterType + 'Card');
            const successMsg = document.createElement('div');
            successMsg.textContent = 'Purchased!';
            successMsg.style.position = 'absolute';
            successMsg.style.top = '50%';
            successMsg.style.left = '50%';
            successMsg.style.transform = 'translate(-50%, -50%)';
            successMsg.style.fontSize = '24px';
            successMsg.style.fontWeight = 'bold';
            successMsg.style.color = '#4CAF50';
            successMsg.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
            successMsg.style.pointerEvents = 'none';
            successMsg.style.animation = 'coinFloat 1.5s ease-out forwards';
            
            card.appendChild(successMsg);
            
            setTimeout(() => {
                if (card.contains(successMsg)) {
                    card.removeChild(successMsg);
                }
            }, 1500);
        }
        
        function showNotEnoughCoins() {
            const errorMsg = document.createElement('div');
            errorMsg.textContent = 'Not enough coins!';
            errorMsg.style.position = 'absolute';
            errorMsg.style.top = '60px';
            errorMsg.style.right = '20px';
            errorMsg.style.fontSize = '18px';
            errorMsg.style.fontWeight = 'bold';
            errorMsg.style.color = '#FF5252';
            errorMsg.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.5)';
            errorMsg.style.pointerEvents = 'none';
            errorMsg.style.animation = 'coinFloat 1.5s ease-out forwards';
            
            document.querySelector('.game-ui').appendChild(errorMsg);
            
            setTimeout(() => {
                if (document.querySelector('.game-ui').contains(errorMsg)) {
                    document.querySelector('.game-ui').removeChild(errorMsg);
                }
            }, 1500);
        }
        
        function selectCharacter(character, shouldScroll = true) {
            if (!characters[character].unlocked) return;
            
            selectedCharacter = character;
            
            // Update UI
            document.querySelectorAll('.character-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(character + 'Card').classList.add('selected');
            
            // Update current index
            const characterTypes = ['bird', 'eagle', 'crow'];
            currentCharacterIndex = characterTypes.indexOf(character);
            updateScrollIndicators();
            
            // Scroll to character if needed
            if (shouldScroll) {
                const characterCards = document.querySelectorAll('.character-card');
                const containerWidth = characterContainer.clientWidth;
                const cardWidth = characterCards[0].offsetWidth + 30; // Include gap
                const scrollPosition = currentCharacterIndex * cardWidth - (containerWidth - cardWidth) / 2;
                characterContainer.scrollTo({
                    left: scrollPosition,
                    behavior: 'smooth'
                });
            }
        }
        
        function drawCharacterPreview(characterType, previewCanvas) {
            const previewCtx = previewCanvas.getContext('2d');
            const char = characters[characterType];
            
            // Clear canvas
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            
            // Center the character
            const centerX = previewCanvas.width / 2;
            const centerY = previewCanvas.height / 2;
            const scale = 1.5;
            
            previewCtx.save();
            previewCtx.translate(centerX, centerY);
            previewCtx.scale(scale, scale);
            
            // Character body
            previewCtx.fillStyle = char.color;
            previewCtx.beginPath();
            previewCtx.ellipse(0, 0, char.width / 2, char.height / 2, 0, 0, Math.PI * 2);
            previewCtx.fill();
            
            // Character eye
            previewCtx.fillStyle = 'white';
            previewCtx.beginPath();
            previewCtx.arc(8, -5, 6, 0, Math.PI * 2);
            previewCtx.fill();
            previewCtx.fillStyle = 'black';
            previewCtx.beginPath();
            previewCtx.arc(10, -5, 3, 0, Math.PI * 2);
            previewCtx.fill();
            
            // Character beak
            previewCtx.fillStyle = char.beakColor;
            previewCtx.beginPath();
            previewCtx.moveTo(15, 0);
            previewCtx.lineTo(25, 0);
            previewCtx.lineTo(15, 5);
            previewCtx.closePath();
            previewCtx.fill();
            
            // Character wing
            previewCtx.fillStyle = char.wingColor;
            previewCtx.beginPath();
            previewCtx.ellipse(-5, 5, 12, 8, -20 * Math.PI / 180, 0, Math.PI * 2);
            previewCtx.fill();
            
            previewCtx.restore();
        }
        
        function startGame() {
            gameState = 'playing';
            characterSelection.classList.add('hidden');
            resetGame();
            gameLoop();
        }
        
        function restartGame() {
            gameState = 'characterSelection';
            gameOverScreen.classList.add('hidden');
            characterSelection.classList.remove('hidden');
        }
        
        function resetGame() {
            const char = characters[selectedCharacter];
            // Adjust bird position based on character size
            bird.y = canvas.height / 2 - (char.height - 24) / 2; // 24 is default bird height
            bird.velocity = 0;
            bird.rotation = 0;
            pipes.length = 0;
            coinsInGame.length = 0;
            pipeTimer = 0;
            coinTimer = 0;
            score = 0;
            coinsEarnedThisRound = 0;
            timePhase = 'day';
            lastPhaseChangeScore = 0;
            scoreElement.textContent = score;
            
            // Clear any existing time indicator timeout
            if (timeIndicatorTimeout) {
                clearTimeout(timeIndicatorTimeout);
                timeIndicator.classList.remove('show');
            }
            
            // Clear all active animations
            clearAllAnimations();
        }
        
        function clearAllAnimations() {
            activeAnimations.forEach(animation => {
                if (animation.parentNode) {
                    animation.parentNode.removeChild(animation);
                }
            });
            activeAnimations = [];
        }
        
        function updateBird() {
            const char = characters[selectedCharacter];
            bird.velocity += char.gravity;
            bird.y += bird.velocity;
            
            // Update rotation based on velocity
            bird.rotation = Math.min(Math.max(bird.velocity * 3, -30), 90);
            
            // Check boundaries
            if (bird.y + char.height > canvas.height - 50) {
                gameOver();
            }
            if (bird.y < 0) {
                bird.y = 0;
                bird.velocity = 0;
            }
        }
        
        function updatePipes() {
            // Add new pipes
            pipeTimer++;
            if (pipeTimer >= pipeInterval) {
                const minHeight = 100;
                const maxHeight = canvas.height - pipeGap - minHeight - 50;
                const topHeight = minHeight + Math.random() * (maxHeight - minHeight);
                
                pipes.push({
                    x: canvas.width,
                    topHeight: topHeight,
                    bottomY: topHeight + pipeGap,
                    passed: false
                });
                pipeTimer = 0;
            }
            
            // Update pipe positions
            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= pipeSpeed;
                
                // Check if bird passed the pipe
                if (!pipes[i].passed && pipes[i].x + pipeWidth < bird.x) {
                    pipes[i].passed = true;
                    score++;
                    scoreElement.textContent = score;
                    updateTimePhase();
                }
                
                // Remove off-screen pipes
                if (pipes[i].x + pipeWidth < 0) {
                    pipes.splice(i, 1);
                }
            }
        }
        
        function updateCoins() {
            // Add new coins
            coinTimer++;
            if (coinTimer >= coinInterval) {
                // Random position between pipes
                const minY = 100;
                const maxY = canvas.height - 150;
                const y = minY + Math.random() * (maxY - minY);
                
                coinsInGame.push({
                    x: canvas.width,
                    y: y,
                    collected: false
                });
                coinTimer = 0;
            }
            
            // Update coin positions
            for (let i = coinsInGame.length - 1; i >= 0; i--) {
                coinsInGame[i].x -= pipeSpeed;
                
                // Check if bird collected the coin
                if (!coinsInGame[i].collected) {
                    const char = characters[selectedCharacter];
                    const birdCenterX = bird.x + char.width / 2;
                    const birdCenterY = bird.y + char.height / 2;
                    const dx = birdCenterX - coinsInGame[i].x;
                    const dy = birdCenterY - coinsInGame[i].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < Math.max(char.width, char.height) / 2 + coinRadius) {
                        // Coin collected
                        coinsInGame[i].collected = true;
                        coins++;
                        coinsEarnedThisRound++;
                        coinCountElement.textContent = coins;
                        
                        // Show coin collected animation
                        showCoinCollected(coinsInGame[i].x, coinsInGame[i].y);
                    }
                }
                
                // Remove off-screen coins
                if (coinsInGame[i].x + coinRadius < 0) {
                    coinsInGame.splice(i, 1);
                }
            }
        }
        
        function showCoinCollected(x, y) {
            const coinText = document.createElement('div');
            coinText.className = 'coin-collected';
            coinText.textContent = '+1';
            coinText.style.left = x + 'px';
            coinText.style.top = y + 'px';
            
            document.querySelector('.game-ui').appendChild(coinText);
            activeAnimations.push(coinText);
            
            setTimeout(() => {
                if (coinText.parentNode) {
                    coinText.parentNode.removeChild(coinText);
                }
                const index = activeAnimations.indexOf(coinText);
                if (index > -1) {
                    activeAnimations.splice(index, 1);
                }
            }, 1000);
        }
        
        function checkCollisions() {
            const char = characters[selectedCharacter];
            
            for (const pipe of pipes) {
                // Check collision with top pipe
                if (bird.x + char.width > pipe.x && 
                    bird.x < pipe.x + pipeWidth &&
                    bird.y < pipe.topHeight) {
                    gameOver();
                    return;
                }
                
                // Check collision with bottom pipe
                if (bird.x + char.width > pipe.x && 
                    bird.x < pipe.x + pipeWidth &&
                    bird.y + char.height > pipe.bottomY) {
                    gameOver();
                    return;
                }
            }
        }
        
        function gameOver() {
            gameState = 'gameOver';
            
            // Save coins
            localStorage.setItem('flappyCoins', coins);
            
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('flappyBestScore', bestScore);
                bestScoreElement.textContent = `Best: ${bestScore}`;
            }
            
            finalScoreElement.textContent = `Score: ${score}`;
            coinsEarnedElement.textContent = `Coins Earned: ${coinsEarnedThisRound}`;
            gameOverScreen.classList.remove('hidden');
        }
        
        function drawBackground() {
            const phase = timePhases[timePhase];
            
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, phase.skyGradient[0]);
            gradient.addColorStop(1, phase.skyGradient[1]);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw clouds
            ctx.fillStyle = phase.cloudColor;
            for (const cloud of clouds) {
                // Update cloud position
                cloud.x -= cloud.speed;
                if (cloud.x + cloud.width < 0) {
                    cloud.x = canvas.width;
                    cloud.y = Math.random() * 150; // Keep clouds in visible area
                }
                
                // Draw cloud
                ctx.beginPath();
                ctx.arc(cloud.x, cloud.y, cloud.width / 3, 0, Math.PI * 2);
                ctx.arc(cloud.x + cloud.width / 3, cloud.y, cloud.width / 2.5, 0, Math.PI * 2);
                ctx.arc(cloud.x + cloud.width * 2/3, cloud.y, cloud.width / 3, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawBird() {
            const char = characters[selectedCharacter];
            
            ctx.save();
            ctx.translate(bird.x + char.width / 2, bird.y + char.height / 2);
            ctx.rotate(bird.rotation * Math.PI / 180);
            
            // Bird body
            ctx.fillStyle = char.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, char.width / 2, char.height / 2, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Bird eye
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(8, -5, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(10, -5, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Bird beak
            ctx.fillStyle = char.beakColor;
            ctx.beginPath();
            ctx.moveTo(15, 0);
            ctx.lineTo(25, 0);
            ctx.lineTo(15, 5);
            ctx.closePath();
            ctx.fill();
            
            // Bird wing
            ctx.fillStyle = char.wingColor;
            ctx.beginPath();
            ctx.ellipse(-5, 5, 12, 8, -20 * Math.PI / 180, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }
        
        function drawPipes() {
            const phase = timePhases[timePhase];
            
            ctx.fillStyle = phase.pipeColor;
            ctx.strokeStyle = phase.pipeStrokeColor;
            ctx.lineWidth = 3;
            
            for (const pipe of pipes) {
                // Top pipe
                ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight);
                ctx.strokeRect(pipe.x, 0, pipeWidth, pipe.topHeight);
                
                // Top pipe cap
                ctx.fillRect(pipe.x - 5, pipe.topHeight - 30, pipeWidth + 10, 30);
                ctx.strokeRect(pipe.x - 5, pipe.topHeight - 30, pipeWidth + 10, 30);
                
                // Bottom pipe
                ctx.fillRect(pipe.x, pipe.bottomY, pipeWidth, canvas.height - pipe.bottomY - 50);
                ctx.strokeRect(pipe.x, pipe.bottomY, pipeWidth, canvas.height - pipe.bottomY - 50);
                
                // Bottom pipe cap
                ctx.fillRect(pipe.x - 5, pipe.bottomY, pipeWidth + 10, 30);
                ctx.strokeRect(pipe.x - 5, pipe.bottomY, pipeWidth + 10, 30);
            }
        }
        
        function drawCoins() {
            for (const coin of coinsInGame) {
                if (!coin.collected) {
                    // Coin body
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coinRadius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Coin highlight
                    ctx.fillStyle = '#FFF700';
                    ctx.beginPath();
                    ctx.arc(coin.x - coinRadius/3, coin.y - coinRadius/3, coinRadius/3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Coin symbol
                    ctx.fillStyle = '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('$', coin.x, coin.y);
                }
            }
        }
        
        function drawGround() {
            const phase = timePhases[timePhase];
            
            // Ground
            ctx.fillStyle = phase.groundColor;
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
            
            // Grass
            ctx.fillStyle = phase.grassColor;
            ctx.fillRect(0, canvas.height - 50, canvas.width, 10);
        }
        
        function gameLoop() {
            if (gameState !== 'playing') return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw everything
            drawBackground();
            drawPipes();
            drawCoins();
            drawBird();
            drawGround();
            
            // Update game state
            updateBird();
            updatePipes();
            updateCoins();
            checkCollisions();
            
            // Continue game loop
            requestAnimationFrame(gameLoop);
        }
        
        // Initialize character cards on page load
        window.addEventListener('load', () => {
            updateCharacterCards();
        });
        
        // Initial draw
        drawBackground();
        drawGround();
    </script>
</body>
</html>